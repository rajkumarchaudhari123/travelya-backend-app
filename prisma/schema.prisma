// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Driver {
  id            String       @id @default(cuid())
  fullName      String
  phone         String       @unique
  email         String?      @unique
  vehicleNumber String
  licenseNumber String       @unique
  idFront       String?
  idBack        String?
  licenseDoc    String?
  rcDoc         String?
  selfie        String?
  journeyType   JourneyType  @default(UNKNOWN)
  fromCity      String?
  toCity        String?
  status        DriverStatus @default(PENDING)
  isOnline      Boolean      @default(false)
  isAvailable   Boolean      @default(true)
  currentLat    Float?
  currentLng    Float?
  rating        Float?       @default(4.5)
  totalRides    Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  notifications DriverNotification[]
  assignedRides RideBooking[]

  @@map("drivers")
}

enum JourneyType {
  INTERCITY
  LOCAL
  BOTH
  UNKNOWN
}

enum DriverStatus {
  PENDING
  ACTIVE
  BLOCKED
}

model Rider {
  id              String   @id @default(uuid())
  fullName        String
  phone           String   @unique
  email           String?  @unique
  profilePhotoUrl String?
  marketingOptIn  Boolean  @default(false)
  acceptTerms     Boolean  @default(false)
  isOnline        Boolean  @default(false)
  currentLat      Float?
  currentLng      Float?
  rating          Float?   @default(5.0)
  totalRides      Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  addresses   RiderAddress[]
  preferences RiderPreference?
  bookings    RideBooking[]

  @@map("riders")
}

model RiderAddress {
  id        String      @id @default(uuid())
  riderId   String
  type      AddressType
  fullText  String
  landmark  String?
  lat       Float?
  lon       Float?
  createdAt DateTime    @default(now())

  rider Rider @relation(fields: [riderId], references: [id], onDelete: Cascade)

  @@map("rider_addresses")
}

model RiderPreference {
  id                 String  @id @default(uuid())
  riderId            String  @unique
  language           String? @default("en")
  accessibilityNeeds String?
  preferredVehicle   String?

  rider Rider @relation(fields: [riderId], references: [id], onDelete: Cascade)

  @@map("rider_preferences")
}

enum AddressType {
  HOME
  WORK
  OTHER
}

model Location {
  id           String   @id @default(cuid())
  place_id     String   @unique
  display_name String
  lat          String
  lon          String
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@map("locations")
}

model RideBooking {
  id           String     @id @default(cuid())
  vehicleType  String
  fromLocation String
  toLocation   String
  fromLat      Float?
  fromLon      Float?
  toLat        Float?
  toLon        Float?
  price        Float
  distance     Float
  status       RideStatus @default(PENDING)

  otpCode       String?   @db.VarChar(10)
  otpExpiresAt  DateTime?
  otpVerified   Boolean   @default(false)
  otpVerifiedAt DateTime?
  otpAttempts   Int       @default(0)

  // Driver assignment
  driverId   String?
  driverName String?

  // Rider relation
  userId String

  // Timestamps
  createdAt   DateTime  @default(now())
  acceptedAt  DateTime?
  arrivedAt   DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  cancelledAt DateTime?
  updatedAt   DateTime  @updatedAt

  // Relations
  notifications DriverNotification[]
  rider         Rider                @relation(fields: [userId], references: [id], onDelete: Cascade)
  driver        Driver?              @relation(fields: [driverId], references: [id], onDelete: SetNull)

  @@map("ride_bookings")
}

enum RideStatus {
  PENDING
  ACCEPTED
  ARRIVED
  STARTED
  OTP_VERIFIED
  COMPLETED
  DECLINED
  CANCELLED
}

model VehicleType {
  id         String   @id @default(cuid())
  name       String   @unique
  icon       String
  basePrice  Float
  pricePerKm Float
  seats      Int
  color      String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("vehicle_types")
}

model DriverNotification {
  id            String           @id @default(cuid())
  driverId      String
  rideBookingId String
  type          NotificationType @default(RIDE_REQUEST)
  status        String
  message       String
  isRead        Boolean          @default(false)
  createdAt     DateTime         @default(now())

  driver      Driver      @relation(fields: [driverId], references: [id], onDelete: Cascade)
  rideBooking RideBooking @relation(fields: [rideBookingId], references: [id], onDelete: Cascade)

  @@map("driver_notifications")
}

enum NotificationType {
  RIDE_REQUEST
  RIDE_UPDATE
  SYSTEM
  PAYMENT
}
